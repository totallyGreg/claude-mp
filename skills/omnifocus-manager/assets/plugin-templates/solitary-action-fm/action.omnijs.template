/*{
	"type": "action",
	"targets": ["omnifocus"],
	"author": "{{AUTHOR}}",
	"identifier": "{{IDENTIFIER}}",
	"version": "1.0",
	"description": "{{DESCRIPTION}}",
	"label": "{{PLUGIN_NAME}}",
	"shortLabel": "{{SHORT_LABEL}}",
	"mediumLabel": "{{MEDIUM_LABEL}}",
	"paletteLabel": "{{PALETTE_LABEL}}",
	"image": "apple.intelligence"
}*/
(() => {
	const action = new PlugIn.Action(async function(selection, sender) {
		try {
			// Check if Foundation Models are available
			if (typeof LanguageModel === 'undefined' || typeof LanguageModel.Session === 'undefined') {
				const alert = new Alert(
					"Apple Intelligence Required",
					"This feature requires:\n" +
					"- OmniFocus 4.8+\n" +
					"- macOS 26+ or iOS 18.2+\n" +
					"- Apple Silicon or iPhone 15 Pro+\n" +
					"- Apple Intelligence enabled in Settings"
				);
				alert.show();
				return;
			}

			// Get tasks using global variable
			const tasks = flattenedTasks.filter(task => {
				return !task.completed && !task.dropped;
			}).slice(0, 10); // Limit for context window

			// Build task summary for AI
			const taskSummary = tasks.map(t => ({
				name: t.name,
				project: t.containingProject ? t.containingProject.name : "Inbox",
				flagged: t.flagged
			}));

			// Create AI session
			const session = new LanguageModel.Session();

			// Define response schema
			const schema = LanguageModel.Schema.fromJSON({
				name: "analysis",
				properties: [
					{
						name: "summary",
						type: "string",
						description: "Brief analysis summary"
					},
					{
						name: "recommendation",
						type: "string",
						description: "Top recommendation"
					}
				]
			});

			// Get AI analysis
			const prompt = `Analyze these tasks and provide brief insights:\n${JSON.stringify(taskSummary, null, 2)}`;
			const result = await session.respondWithSchema(prompt, schema);

			// Display result
			const message = `${result.summary || "Analysis complete."}\n\nRecommendation: ${result.recommendation || "Focus on flagged items first."}`;
			const alert = new Alert("{{PLUGIN_NAME}}", message);
			alert.show();

		} catch (error) {
			const alert = new Alert("Error", error.message);
			alert.show();
		}
	});

	action.validate = function(selection, sender) {
		// Require macOS 26+ for Apple Foundation Models
		return (Device.current.operatingSystemVersion.atLeast(new Version("26")));
	};

	return action;
})();
