/*{
	"type": "library",
	"targets": ["omnifocus"],
	"identifier": "{{IDENTIFIER}}",
	"version": "1.0"
}*/
(() => {
	const lib = new PlugIn.Library(new Version("1.0"));

	/**
	 * Get active (non-completed, non-dropped) tasks
	 * @returns {Array} Array of active task objects
	 */
	lib.getActiveTasks = function() {
		return flattenedTasks.filter(task => {
			return !task.completed && !task.dropped;
		});
	};

	/**
	 * Get tasks due today
	 * @returns {Array} Array of tasks due today
	 */
	lib.getTodayTasks = function() {
		const today = new Date();
		today.setHours(0, 0, 0, 0);
		const tomorrow = new Date(today);
		tomorrow.setDate(tomorrow.getDate() + 1);

		return flattenedTasks.filter(task => {
			if (task.completed || task.dropped) return false;
			const due = task.dueDate;
			return due && due >= today && due < tomorrow;
		});
	};

	/**
	 * Get overdue tasks
	 * @returns {Array} Array of overdue tasks
	 */
	lib.getOverdueTasks = function() {
		const today = new Date();
		today.setHours(0, 0, 0, 0);

		return flattenedTasks.filter(task => {
			if (task.completed || task.dropped) return false;
			const due = task.dueDate;
			return due && due < today;
		});
	};

	/**
	 * Get flagged tasks
	 * @returns {Array} Array of flagged tasks
	 */
	lib.getFlaggedTasks = function() {
		return flattenedTasks.filter(task => {
			return task.flagged && !task.completed && !task.dropped;
		});
	};

	/**
	 * Normalize task to a plain object for serialization
	 * @param {Task} task - OmniFocus task object
	 * @returns {Object} Plain object with task properties
	 */
	lib.normalizeTask = function(task) {
		return {
			name: task.name,
			project: task.containingProject ? task.containingProject.name : null,
			tags: task.tags.map(tag => tag.name),
			dueDate: task.dueDate,
			deferDate: task.deferDate,
			flagged: task.flagged,
			completed: task.completed,
			estimatedMinutes: task.estimatedMinutes,
			note: task.note || ""
		};
	};

	/**
	 * Display library info in console
	 */
	lib.info = function() {
		const props = Object.getOwnPropertyNames(lib);
		props.forEach((propName, index) => {
			if (index !== 0) console.log(" ");
			console.log("*", propName);
			const item = lib[propName];
			if (typeof item === "function") {
				console.log(item.toString());
			} else if (item instanceof Version) {
				console.log(item.versionString);
			}
		});
	};

	return lib;
})();
